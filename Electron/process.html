<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>processing window</title>
    <!-- Hidden window for offloading processes from main.js -->
  </head>
  <body>
    <script>
      window.ipcBridge.handle('logData', (event, serviceName)=> getLogs(serviceName));
      window.ipcBridge.handle('tracerData', (event, serviceName)=> getTracers(serviceName));


      const data = {
  logs: [],
  tracers: []
}

const log = {
  src: 'serviceA',
  msg: 'Service A fetching data from Service B',
  time: '2022-10-20 17:05:05.732507'
}

const newLog = (src, msg, time) => {
  const nLog = {...log};
  if(src) nLog.src = src;
  if(msg) nLog.msg = msg;
  if(time) nLog.time = time;
  return nLog;
}

const tracer = {
  src: 'serviceA',
  dest: 'serviceB',
  traceId: '',
  sender: true,
  starttime: '2022-10-20 17:05:05.732507',
  endtime: '2022-10-20 17:05:10.732507',
  completed: true
}

const newTracer = (src, dest, traceId, sender, starttime, endtime, completed)=> {
  const nTracer = {...tracer};
  if(src) nTracer.src = src;
  if(dest) nTracer.dest = dest;
  if(traceId) nTracer.traceId = traceId;
  if(sender) nTracer.sender = sender;
  if(starttime) nTracer.starttime = starttime;
  if(endtime) nTracer.endtime = endtime;
  if(completed !== undefined) nTracer.completed = completed;
  return nTracer;
}

data.generateLogs = serviceName => {
  console.log('hit');
  if(data.logs.length > 15) return;
  for(let i=0; i<2; i++){
    const msg = i % 2 === 0 ? 'fetching data from dbaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa' : 'data received';
    data.logs.push(
      newLog(serviceName, msg, new Date().toISOString().slice(0, 19).replace('T', ' '))
    );
  }
}

data.generateTracers = serviceName => {
  if(data.tracers.length > 15) return;
  for(let i=0; i<2; i++){
    const starttime = new Date().toISOString().slice(0, 19).replace('T', ' ');
    const endtime = new Date().toISOString().slice(0, 19).replace('T', ' ');
    if(i % 2 === 0){ // sender
      data.tracers.push(
        newTracer(
          serviceName, 
          'serviceB', 
          `${i}`,
          true,
          starttime,
          endtime,
          true
        )
      );
    }
    else{ // receiver
      data.tracers.push(
        newTracer(
          'serviceB',
          'serviceB',
          `${i-1}`,
          false,
          starttime,
          endtime,
          true
        )
      );
    }
  }
}



      // Generate mock logs data
      const getLogs = async (serviceName) => {
        data.generateLogs(serviceName);
        if(!serviceName) return data.logs;
        const serviceLogs = [];
        for(const log of data.logs){
          if(log.src === serviceName) serviceLogs.push(log);
        }
        window.ipcBridge.send('sendClient', 'res', serviceLogs);
      }
      // Generate mock tracers data
      const getTracers = async (serviceName) => {
        data.generateTracers(serviceName);
        if(!serviceName) return data.tracers;
        const serviceTracers = [];
        for(const tracer of data.tracers){
          if(tracer.src === serviceName || tracer.dest === serviceName)
            serviceTracers.push(tracer);
        }
        window.ipcBridge.send('sendClient', serviceTracers);
      }
    </script>
  </body>
</html>